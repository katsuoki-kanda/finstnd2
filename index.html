<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Gesture Game - Left & Right Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        body { margin: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { position: absolute; left: 0; top: 0; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 20; pointer-events: none; text-shadow: 2px 2px 4px black; }
        .stat { font-size: 24px; margin-bottom: 10px; font-weight: bold; color: #00ff00; }
        
        #question-image { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            max-width: 75vw; 
            max-height: 75vh; 
            z-index: 10; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            border-radius: 15px; 
            border: 10px solid transparent;
            transition: border-color 0.15s;
        }

        #message { 
            position: absolute; 
            bottom: 12%; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 45px; 
            color: #ffff00; 
            text-align: center; 
            z-index: 30; 
            text-shadow: 3px 3px 0 #000; 
            font-weight: bold;
            width: 100%;
        }

        #start-btn { 
            position: absolute; 
            top: 68%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            padding: 18px 36px; 
            font-size: 26px; 
            cursor: pointer; 
            pointer-events: auto; 
            z-index: 35; 
            border-radius: 50px; 
            background: #00ff00; 
            border: 2px solid #fff; 
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
        }
        #start-btn:active { background: #00cc00; transform: translate(-50%, -48%); }
    </style>
</head>
<body>

<div id="game-container">
    <video id="input_video" style="display:none"></video>
    <canvas id="output_canvas"></canvas>
    
    <div id="ui-layer">
        <div class="stat">Score: <span id="score">0</span></div>
        <div class="stat">Time: <span id="timer">45</span></div>
    </div>

    <img id="question-image" src="0.jpg" alt="Status Image">
    <div id="message">カメラ起動中...</div>
    <button id="start-btn" onclick="startGameManual()">ゲーム開始</button>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const questionImageEl = document.getElementById('question-image');
    const messageEl = document.getElementById('message');
    const startBtn = document.getElementById('start-btn');

    let score = 0;
    let timeLeft = 45;
    let gameStarted = false;
    let currentTarget = { number: 0, hand: '' };
    let lastTarget = { number: 0, hand: '' };
    let lastCorrectTime = 0;
    let gameTimerInterval;
    let isCameraReady = false;

    const speech = window.speechSynthesis;
    function speak(text) {
        if (speech.speaking) { speech.cancel(); }
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP';
        speech.speak(uttr);
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep() {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(900, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.1);
    }

    function startGameManual() {
        if (gameStarted || !isCameraReady) return;
        startBtn.style.display = 'none';
        messageEl.innerText = "";
        score = 0;
        scoreEl.innerText = score;
        timeLeft = 45;
        timerEl.innerText = timeLeft;
        gameStarted = true;
        lastTarget = { number: 0, hand: '' };
        nextQuestion();
        speak("スタート");
        
        clearInterval(gameTimerInterval);
        gameTimerInterval = setInterval(() => {
            timeLeft--;
            timerEl.innerText = timeLeft;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        let nextNum, nextHand;
        do {
            nextNum = Math.floor(Math.random() * 10) + 1;
            nextHand = Math.random() < 0.5 ? 'Right' : 'Left';
        } while (nextNum === lastTarget.number && nextHand === lastTarget.hand);

        currentTarget = { number: nextNum, hand: nextHand };
        lastTarget = { ...currentTarget };

        const suffix = (currentTarget.hand === 'Left') ? 'b' : '';
        questionImageEl.src = `${currentTarget.number}${suffix}.jpg`;
    }

    function endGame() {
        gameStarted = false;
        clearInterval(gameTimerInterval);
        questionImageEl.src = "0.jpg";
        questionImageEl.style.borderColor = "transparent";
        messageEl.innerHTML = `終了！<br>スコア: ${score}点`;
        speak(`${score}点です。終了。`);
        startBtn.style.display = 'block';
        startBtn.innerText = "もう一度プレイ";
    }

    function onResults(results) {
        if (!isCameraReady && results.image) {
            isCameraReady = true;
            messageEl.innerText = "手を挙げてスタート！";
            startBtn.style.display = 'block';
        }

        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;

        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.scale(-1, 1);
        canvasCtx.drawImage(results.image, -canvasElement.width, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            let topHandIndex = -1;
            let minY = 1.0;

            // 1. 最も高い位置にある手を探す
            for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                const wristY = results.multiHandLandmarks[i][0].y;
                if (wristY < minY) {
                    minY = wristY;
                    topHandIndex = i;
                }
            }

            if (topHandIndex !== -1) {
                const landmarks = results.multiHandLandmarks[topHandIndex];
                const detectedHandLabel = results.multiHandedness[topHandIndex].label;

                // 【追加ロジック】手が垂れ下がっているかチェック
                // 手首(0)が中指の付け根(9)より下にある（Y座標が大きい）場合のみ有効とする
                // MediaPipeのY軸は上が0、下が1
                const isHandUpright = landmarks[0].y > landmarks[9].y;

                if (isHandUpright) {
                    // 描画
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                    drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2, radius: 3});

                    const handSize = Math.hypot(landmarks[0].x - landmarks[9].x, landmarks[0].y - landmarks[9].y);
                    const threshold = handSize * 0.12; 

                    let f1 = 0;
                    const thumbXdiff = landmarks[4].x - landmarks[3].x;
                    if (detectedHandLabel === 'Left') {
                        f1 = thumbXdiff > (threshold * 0.4) ? 1 : 0;
                    } else {
                        f1 = thumbXdiff < -(threshold * 0.4) ? 1 : 0;
                    }

                    const f2 = (landmarks[6].y - landmarks[8].y) > threshold ? 1 : 0;
                    const f3 = (landmarks[10].y - landmarks[12].y) > threshold ? 1 : 0;
                    const f4 = (landmarks[14].y - landmarks[16].y) > threshold ? 1 : 0;
                    const f5 = (landmarks[18].y - landmarks[20].y) > threshold ? 1 : 0;

                    // ゲーム開始判定（しっかり手が上がっている場合のみ）
                    if (!gameStarted && isCameraReady && landmarks[0].y < 0.4) {
                        startGameManual();
                    }

                    if (gameStarted) {
                        let detectedNum = -1;
                        if (f1==0 && f2==1 && f3==0 && f4==0 && f5==0) detectedNum = 1;
                        else if (f1==0 && f2==1 && f3==1 && f4==0 && f5==0) detectedNum = 2;
                        else if (f1==0 && f2==1 && f3==1 && f4==1 && f5==0) detectedNum = 3;
                        else if (f1==0 && f2==1 && f3==1 && f4==1 && f5==1) detectedNum = 4;
                        else if (f1==1 && f2==1 && f3==1 && f4==1 && f5==1) detectedNum = 5;
                        else if (f1==1 && f2==0 && f3==0 && f4==0 && f5==0) detectedNum = 6;
                        else if (f1==1 && f2==1 && f3==0 && f4==0 && f5==0) detectedNum = 7;
                        else if (f1==1 && f2==1 && f3==1 && f4==0 && f5==0) detectedNum = 8;
                        else if (f1==0 && f2==0 && f3==1 && f4==1 && f5==1) detectedNum = 9;
                        else if (f1==0 && f2==1 && f3==0 && f4==0 && f5==1) detectedNum = 10;

                        if (detectedNum === currentTarget.number && detectedHandLabel === currentTarget.hand) {
                            const now = Date.now();
                            if (now - lastCorrectTime > 600) {
                                score++;
                                scoreEl.innerText = score;
                                beep();
                                lastCorrectTime = now;
                                
                                messageEl.innerText = "OK!";
                                questionImageEl.style.borderColor = "#ff0000";
                                
                                setTimeout(() => { 
                                    if(gameStarted) {
                                        messageEl.innerText = ""; 
                                        questionImageEl.style.borderColor = "transparent";
                                    }
                                }, 300);
                                
                                nextQuestion();
                            }
                        }
                    }
                } else {
                    // 手が垂れている時は、スケルトン描画も判定も行わない（＝無視）
                }
            }
        }
        canvasCtx.restore();
    }

    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 640,
        height: 480
    });
    camera.start();
</script>

</body>
</html>